listenAddress: 0.0.0.0:7202

carbon:
  ingester:
    listenAddress: "0.0.0.0:7204"
    rules:
      - pattern: .*
        aggregation:
          type: mean
        policies:
          - resolution: 10s
            retention: 6h

clusters:
  - client:
      config:
        service:
          env: default_env
          zone: embedded
          service: m3db
          cacheDir: /var/lib/m3kv
          etcdClusters:
            - zone: embedded
              endpoints:
                - dbnode01:2379

downsample:
  rules:
    # mappingRules:
    # - name: "drop coordinator handler latency all"
    #   filter: __name__:coordinator_http_handler_http_handler_latency_bucket
    #   drop: true
    #   dropType: all
    rollupRules:
      - name: "coordinator handler latency without instance"
        filter: "__name__:coordinator_http_handler_http_handler_latency_bucket"
        transforms:
          - transform:
              type: "Increase"
          - rollup:
              metricName: "{{ .MetricName }}:without_instance"
              excludeBy: ["instance"]
              aggregations: ["Sum"]
          - transform:
              type: "Add"
        storagePolicies:
          - resolution: 10s
            retention: 6h
      - name: "requests per second by status code"
        filter: "__name__:http_requests app:* status_code:* endpoint:*"
        transforms:
          - transform:
              type: "PerSecond"
          - rollup:
              metricName: "http_requests_by_status_code"
              groupBy: ["app", "status_code", "endpoint"]
              aggregations: ["Sum"]
        storagePolicies:
          - resolution: 10s
            retention: 6h
  remoteAggregator:
    client:
      type: m3msg
      m3msg:
        producer:
          writer:
            topicName: aggregator_ingest
            topicServiceOverride:
              zone: embedded
              environment: override_test_env
            placement:
              isStaged: true
            placementServiceOverride:
              namespaces:
                placement: /placement
            connection:
              numConnections: 4
            messagePool:
              size: 16384
              watermark:
                low: 0.2
                high: 0.5

ingest:
  ingester:
    workerPoolSize: 10000
    opPool:
      size: 10000
    retry:
      maxRetries: 3
      jitter: true
    logSampleRate: 0.01
  m3msg:
    server:
      listenAddress: "0.0.0.0:7507"
      retry:
        maxBackoff: 10s
        jitter: true

storeMetricsType: true
